name: ðŸ”„ å†…å®¹åº“CSVæ–‡ä»¶è‡ªåŠ¨æå–

on:
  # å½“articlesç›®å½•æœ‰å˜åŒ–æ—¶è§¦å‘
  push:
    paths:
      - 'articles/å†…å®¹åº“*.csv'
      - 'articles/*å†…å®¹åº“*.csv'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_process:
        description: 'å¼ºåˆ¶å¤„ç†æ‰€æœ‰å†…å®¹åº“æ–‡ä»¶'
        required: false
        default: false
        type: boolean

jobs:
  extract-content-db:
    name: ðŸ“Š æå–å†…å®¹åº“æ•°æ®
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ”§ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ðŸ” æ£€æŸ¥å†…å®¹åº“æ–‡ä»¶
        id: check_files
        run: |
          if ls articles/å†…å®¹åº“*.csv 2>/dev/null || ls articles/*å†…å®¹åº“*.csv 2>/dev/null; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ å‘çŽ°å†…å®¹åº“CSVæ–‡ä»¶"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æœªå‘çŽ°å†…å®¹åº“CSVæ–‡ä»¶"
          fi

      - name: ðŸ“Š æå–å†…å®¹åº“æ•°æ®
        if: steps.check_files.outputs.found == 'true' || github.event.inputs.force_process == 'true'
        run: |
          echo "ðŸš€ å¼€å§‹æå–å†…å®¹åº“æ•°æ®..."
          node scripts/extract-content-db.js

      - name: ðŸ“ æäº¤æ›´æ”¹
        if: steps.check_files.outputs.found == 'true' || github.event.inputs.force_process == 'true'
        run: |
          # é…ç½®Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ å‘çŽ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
            
            # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
            git add articles/ready-to-publish.csv
            git add articles/processed-backups/ 2>/dev/null || true
            
            # æäº¤æ›´æ”¹
            git commit -m "ðŸ¤– è‡ªåŠ¨æå–å†…å®¹åº“CSVæ•°æ®
            
            âœ¨ å¤„ç†å®Œæˆ:
            - ðŸ“Š æå–æ–‡ç« æ•°æ®åˆ°ready-to-publish.csv
            - ðŸ—‘ï¸ æ¸…ç†å·²å¤„ç†çš„å†…å®¹åº“æ–‡ä»¶  
            - ðŸ’¾ åˆ›å»ºå¤‡ä»½æ–‡ä»¶
            - â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" || echo "æ— éœ€æäº¤æ›´æ”¹"
            
            # æŽ¨é€æ›´æ”¹
            git push
            echo "âœ… æ›´æ”¹å·²æŽ¨é€åˆ°ä»“åº“"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
          fi

      - name: ðŸ“‹ ç”Ÿæˆå¤„ç†æŠ¥å‘Š
        if: steps.check_files.outputs.found == 'true' || github.event.inputs.force_process == 'true'
        run: |
          echo "## ðŸ“Š å†…å®¹åº“å¤„ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ å¤„ç†çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "articles/ready-to-publish.csv" ]; then
            article_count=$(tail -n +2 articles/ready-to-publish.csv | wc -l)
            echo "- âœ… ready-to-publish.csv å·²æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ å½“å‰å‘å¸ƒé˜Ÿåˆ—: ${article_count} ç¯‡æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "articles/processed-backups" ]; then
            backup_count=$(ls articles/processed-backups/ | wc -l)
            echo "- ðŸ’¾ å¤‡ä»½æ–‡ä»¶: ${backup_count} ä¸ª" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– ç³»ç»Ÿå°†åœ¨å®šæ—¶ä»»åŠ¡ä¸­è‡ªåŠ¨å‘å¸ƒæ–‡ç« " >> $GITHUB_STEP_SUMMARY
          echo "- â° å‘å¸ƒæ—¶é—´: æ¯å¤© 6:00, 12:00, 18:00, 24:00 (åŒ—äº¬æ—¶é—´)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š å¯åœ¨Actionsé¡µé¢æŸ¥çœ‹å‘å¸ƒçŠ¶æ€" >> $GITHUB_STEP_SUMMARY 